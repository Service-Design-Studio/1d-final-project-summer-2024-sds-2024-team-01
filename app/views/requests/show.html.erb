<!DOCTYPE html>
<html lang="en">

<body onload="initialize()">

  <div class="container content">
    <div class="request-image-container_requests_details">
      <% if @request.thumbnail.attached? %>
        <img src="<%= image_url(@request.thumbnail) %>" alt="Request Image" class="request-image_requests_details">
      <% end %>
      <div class="btn-report_requests_details">
        <a href="/requests" class="btn btn-back_to_requests">
          <i class="bi bi-arrow-left"></i> Back to requests
        </a>
        <button class="btn btn-danger">
          <i class="fas fa-flag"></i> Report
        </button>
      </div>
    </div>
    <div class="card custom-card_requests_details">
      <div class="card-body p-0">
        <div class="p-3 row">
          <div class="col-md-8">
            <h1 class="mt-3"><%= @request.title %> <i class="bi bi-bookmark"></i> (65)</h1>
            <div class="divider_requests_details"></div>
            <div class="details-section_requests_details">
              <h5>Details</h5>
              <div class="details-item_requests_details">
                <i class="fas fa-calendar-alt"></i>
                <span><%= @request.date.strftime('%d %B %Y') %></span>
              </div>
              <div class="details-item_requests_details">
                <i class="fas fa-clock"></i>
                <span><%= @request.start_time.strftime('%H:%M') %> , lasting <%= @request.duration %> hours</span>
              </div>
              <div class="details-item_requests_details">
                <i class="fas fa-users"></i>
                <span><%= @request.number_of_pax %></span>
              </div>
              <div class="details-item_requests_details">
                <i class="fas fa-map-marker-alt"></i>
                <span id="address">Loading address...</span>
              </div>
              <div class="details-item_requests_details">
                <i class="fas fa-money-bill-wave"></i>
                <span><%= @request.reward %></span>
              </div>
            </div>
            <div class="divider_requests_details"></div>
            <div class="description_requests_details">
              <h5>Description</h5>
              <p><%= @request.description %></p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card profile-card_requests_details mt-3">
              <div class="profile-info_requests_details mb-3">
                <img src="<%= @request.user.avatar %>" alt="<%= @request.user.name %>" width="50" height="50">
                <div>
                  <h5 class="mb-1"><%= @request.created_by %></h5>
                  <p class="mb-1 stars_requests_details">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i> (120 reviews)
                  </p>
                </div>
              </div>
              <button class="btn custom-btn-dark-purple my-4 w-60">Chat</button>
              <div class="request-availability_requests_details mt-2">
                <div class="availability-indicator_requests_details">50 slots</div>
                <%= button_to 'Apply', {:controller => "requests", :action => "apply", :id => @request.id, :method => :post }, { class: 'accept-button_requests_details'} %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-3">
      <%= link_to "Edit this request", edit_request_path(@request), class: "btn btn-warning w-100" %>
      <%= button_to "Destroy this request", @request, method: :delete, data: { confirm: 'Are you sure?' }, class: "btn btn-danger w-100 mt-2" %>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmJgdI9NNTfvR-syec5qEbIBnSVoqKe6I&libraries=places"></script>
  <script>
    function initialize() {
      var geocoder = new google.maps.Geocoder();

      // Extract latitude and longitude from @request.location in POINT(lat lng) format
      var geocode = "<%= @request.location %>";
      var latLngString = geocode.replace('POINT', '').replace('(', '').replace(')', '').trim();
      var latLngArray = latLngString.split(/\s+/); // Split by one or more spaces

      if (latLngArray.length !== 2) {
        console.error('Invalid geocode format:', geocode);
        document.getElementById('address').textContent = 'Invalid geocode format';
        return;
      }

      var latLng = { lat: parseFloat(latLngArray[1]), lng: parseFloat(latLngArray[0]) };

      // Log the latitude and longitude values
      console.log('Latitude:', latLng.lat);
      console.log('Longitude:', latLng.lng);

      if (isNaN(latLng.lat) || isNaN(latLng.lng)) {
        console.error('Invalid latitude or longitude:', latLng);
        document.getElementById('address').textContent = 'Invalid latitude or longitude';
        return;
      }

      geocoder.geocode({ 'location': latLng }, function(results, status) {
        if (status === 'OK') {
          if (results[0]) {
            document.getElementById('address').textContent = results[0].formatted_address;
          } else {
            document.getElementById('address').textContent = 'No results found';
          }
        } else {
          console.error('Geocoder failed due to:', status);
          document.getElementById('address').textContent = 'Geocoder failed due to: ' + status;
        }
      });
    }

    google.maps.event.addDomListener(window, 'load', initialize);
  </script>

</body>
</html>
